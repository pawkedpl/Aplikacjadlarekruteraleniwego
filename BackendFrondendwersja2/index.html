<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leniwy Rekruter – webówka (Spring + OpenRouter)</title>
  <style>
    body { font-family: system-ui; background: #f6f7fb; margin: 0; padding: 24px; color: #111; }
    .container { max-width: 840px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px #0001; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .badge { color:#666; font-size:13px; }
    textarea { width:100%; min-height:150px; border-radius:8px; padding:10px; font-size:14px; border:1px solid #ccc; resize: vertical; }
    button { background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:999px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#666; font-size:14px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
    ul { list-style:none; padding:0; }
    li { border-bottom:1px solid #eee; padding:6px 0; }
    .center { text-align:center; padding: 24px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Leniwy Rekruter</h2>
      <span class="badge"><span id="badgeCount">—</span> pytań • ocena przez AI</span>
    </div>

    <div id="loading" class="center">Ładowanie pytań z serwera…</div>
    <div id="error" class="center" style="display:none;color:#b91c1c;"></div>

    <div id="mainCard" style="display:none;">
      <div id="qMeta" class="muted"></div>
      <div id="qTopic" class="muted"></div>
      <h3 id="qTitle"></h3>
      <textarea id="answer" placeholder="Twoja odpowiedź…"></textarea>
      <div class="toolbar">
        <button id="gradeBtn">Oceń i przejdź dalej</button>
        <div class="muted">Średnia: <b id="mean">0.00</b></div>
      </div>
    </div>

    <div id="summaryCard" style="display:none; text-align:center;">
      <h3>Wynik końcowy</h3>
      <div style="font-size:40px; font-weight:bold;"><span id="finalMean">0.00</span>/5</div>
      <ul id="resultsList"></ul>
      <button id="restartBtn">Rozpocznij od nowa</button>
    </div>

    <p class="muted" style="margin-top:20px;">
      Backend: <b>http://localhost:8080</b> (<code>/api/v1/getForm</code>, <code>/grade</code>)
    </p>
  </div>

  <script>
    const API_BASE = "http://localhost:8080";

    // Stan
    let QUESTIONS = [];
    let index = 0;
    const results = [];
    const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;

    // Pobieranie pytań z serwera
    async function loadQuestions(){
      const res = await fetch(`${API_BASE}/api/v1/getForm`);
      if (res.status === 404) throw new Error("Brak pytań w bazie (HTTP 404).");
      if (!res.ok) throw new Error(`Błąd ładowania pytań: HTTP ${res.status}`);
      const data = await res.json();

      // Oczekiwany kształt: { questions: [{ id, question }] } (z Twojego Springa)
      const items = (data && data.questions) ? data.questions : [];
      if (!Array.isArray(items) || items.length === 0) {
        throw new Error("Serwer zwrócił pustą listę pytań.");
      }

      // Zmapuj do formatu frontu {id, topic, prompt}
      QUESTIONS = items.map((q, idx) => ({
        id: q.id ?? (idx + 1),
        topic: q.topic || "Pytanie ogólne",
        prompt: q.prompt || q.question || String(q)
      }));

      document.getElementById("badgeCount").textContent = QUESTIONS.length;
    }

    // Wywołanie AI
    async function apiGrade(question, answer){
      const resp = await fetch(`${API_BASE}/grade`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({question, answer})
      });
      if(!resp.ok){
        const txt = await resp.text().catch(()=> "");
        throw new Error(`Błąd backendu (HTTP ${resp.status}) ${txt ? "- " + txt : ""}`);
      }
      return resp.json();
    }

    async function grade(){
      const q = QUESTIONS[index];
      const text = document.getElementById("answer").value.trim();
      if(!text) return;
      const btn = document.getElementById("gradeBtn");
      btn.disabled = true; btn.textContent = "Ocenianie…";
      try {
        const out = await apiGrade(q.prompt, text);
        results.push(out);
        index++;
        render();
      } catch(e){ alert(e.message); }
      btn.disabled = false; btn.textContent = "Oceń i przejdź dalej";
    }

    function render(){
      const main = document.getElementById("mainCard");
      const summary = document.getElementById("summaryCard");

      if(index >= QUESTIONS.length){
        main.style.display="none"; summary.style.display="block";
        const m = avg(results.map(r=>r.score));
        document.getElementById("finalMean").textContent = m.toFixed(2);
        document.getElementById("resultsList").innerHTML = results.map((r,i)=>`<li><b>Pytanie ${i+1}:</b> ${r.score}/5<br><small>${r.feedback}</small></li>`).join('');
        return;
      }

      const q = QUESTIONS[index];
      document.getElementById("qMeta").textContent = `Pytanie ${index+1} z ${QUESTIONS.length}`;
      document.getElementById("qTopic").textContent = q.topic || "";
      document.getElementById("qTitle").textContent = q.prompt;
      document.getElementById("answer").value = "";
      document.getElementById("mean").textContent = avg(results.map(r=>r.score)).toFixed(2);

      summary.style.display="none";
      main.style.display="block";
    }

    async function boot(){
      const loading = document.getElementById("loading");
      const errorEl = document.getElementById("error");
      try{
        await loadQuestions();
        loading.style.display = "none";
        errorEl.style.display = "none";
        render();
      }catch(err){
        loading.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = err.message || String(err);
      }
    }

    document.getElementById("gradeBtn").onclick = grade;
    document.getElementById("restartBtn").onclick = ()=>{index=0;results.length=0;render();};
    boot();
  </script>
</body>
</html>
